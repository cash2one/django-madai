{% extends 'website/website.base.inc.html' %}
{% load static %}
{% block title %} 小麻袋 {% endblock title %}


{% block extracss %}
<link rel="stylesheet" href="{% static 'hotel/styles/app.css' %}" media="screen"/>
{% endblock extracss %}

{% block main_content %}
{% include 'website/header.inc.html' %}
<section class="bg-1 bg-image-white-light">
  <div class="bottom-shade-large"></div>
  <article class="list-group">
    <div class="grid list">
      <div class="margin-0-center text-center ajax-loader">
        <img src="{% static 'website/img/ajax-loader.gif' %}" />
      </div>
    </div>
  </article>
</section>
{% endblock main_content %}

{% block extrajs %}
  <script type="text/javascript">
    $(document).ready(function() {
      loadList();
    });

    var cursor = Math.round(new Date().getTime() / 1000);
    var onLoad = false;
    var touchEnd = false;

    function loadList() {
      if (touchEnd) {
        return false;
      }
      if (onLoad) {
        return false;
      }
      onLoad = true;
      $('.ajax-loader').show();
      $.getJSON(
        '{% url 'website:hotel:hotel_list' %}?cursor=' + cursor,
        function(data) {
          if (data.length == 0) {
            touchEnd = true;
          }
          $.each(data, function (index, hotel) {
            cursor = hotel.updated;
            var content = '' +
              '<div class="row cursor-pointer">' +
              '  <div>' +
              '    <div class="span4">' +
              '      <img src="' + hotel.img + '"/>' +
              '    </div>' +
              '    <div class="span8">' +
              '      <h2 class="fg-grayDark">' + hotel.name + '</h2>' +
              '      <p class="fg-grayLight">' + hotel.summary + '</p>' +
              '      <span class="currency">' +
              '        <strong>&yen; ' + hotel.price + '</strong>' +
              '        <small>/晚</small>' +
              '      </span>' +
              '    </div>' +
              '  </div>' +
              '</div>';
            $('.ajax-loader').before(content);
          });
          $('.ajax-loader').hide();
          setTimeout(function () {
            onLoad = false;
          }, 500);
        }
      );
    }

    function scrollAndLoad() {
      if ($(window).scrollTop() > ($('.grid.list').height() + $('.grid.list').offset().top - $(window).height())) {
        loadList();
      }
    }

    $(window).scroll(function(){
      scrollAndLoad();
    });

    $(function(){
      setTimeout(function(){scrollAndLoad();}, 100);
    })
  </script>
{% endblock extrajs %}